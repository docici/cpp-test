本文档由hongjun.liao <docici@126.com>编写，最后更新2017/05

nginx等日志分析程序: plcdn_la

简介: 分析nginx,srs等日志文件,统计各种结果,并分类整理;快速格式转换
使用工具/技术: Linux, C/C++(含C/C++11), shell,eclipse, 运行平台: Linux(Windows平台请使用MinGW)

主要功能:
支持nginx,srs(参见https://github.com/ossrs/srs/wiki/v2_CN_Home) 
两种日志格式,支持按字段(如时间间隔)合并两者统计结果;快速分析及分类整理原始日志
(如按域名,按节点,按用户或时间间隔等建立层级目录结构);快速统计流量,带宽,HTTP状态码,请求URL,user_agent,
客户IP(如访问次数,访问速度,来源分析)等多种数据项;支持指定时间间隔,起止时间限定,阈值限定,输出文件名(或路径)格式自定义,
甚至输出表字段格式;按自定义格式快速日志格式转换; 对输出结果再统计(如按用户合并结果);

代码说明:
(1)为提高代码可读性及可维护性, 工程整体尽量简洁明了,文件名分门别类; 类/结构/函数体尽量功能明确,控制数量,体积合理,关键代码处有相应注释;

(2)主要代码以C,C++结合的方式,使用C++适当抽象(如把日志按时间间隔,客户IP,区域运营商等分组),又不失C的灵活性;

(3)最终使用mmap减小复制量,提高分析速度, 对于nginx日志文件,支持数据块分段使用多线程分析;

(4)nginx日志分析流程: 初始化(解析命令行,载入各种配置文件)->使用mmap映射日志文件到内存->将日志分段, 交由各个线程->
   各个线程按行解析出每条日志->解析结果参与各种数据项的统计->合并线程的统计结果->根据命令行参要求的目录布局及文格式
   输出统计结果(或分类日志),并进行必要的合并;

(5)使用libpopt处理命令行参数, 因为参数数量的关系,也增加了部分自定义格式(参见plcdn_la -e参数);

(6)解析单行日志的核心函数do_parse_nginx_log_item有多个重载版本, 重载因素有:是添加\0还是使用指针指向来区分字段结尾,是否分析字段中的子字段;

(7)对于nginx日志分析, 支持两种工作模式, 第1种普通的分析模式: 分析文件,输出结果, 适应于分析大的日志文件;第2种转储模式,日志文件按每条日志的日期
   追加到不同的文件里, 且称这些为"转储文件"(这些文件以时间间隔命名), 然后分析那些被修改的转储文件, 下次再运行时, 执行同样的操作, 并覆盖输出结果.
   在这种模式下, 需要指定一个最大过期时间,以便清除过期的转储文件.
   这种方式适应于需要周期性转储nginx服务进程的日志(使用 nginx -s reopen);

(8)srs日志格式不同于nginx, 为方便统计分析, srs日志增加了自定义格式, 使单条日志里包含了完整的信息, 不再需要查看上下文日志; 当然, 官方的格式
   也是支持的, 详见plcdn_la --help; srs工作目录: /home/jun/git/srs-2.0release

(9)使用src/tools/目录下build_plcdn_la.sh以生成分析程序静态可执行文件(执行命令 shell-test build_plcdn_la)

(10)关于日志格式转换, 按领导的要求, 按自定义的语法描述新格式, 该格式支持自定义字段顺序,自定义字符, 提供了足够的灵活性, 详见pl_logtrans_trans_file
    (注: 用户云端使用的线上的版本非此版本)

(11)plcdn_la --help输出详细的帮助文档, 相关描述请以此为准

(12)参见doc/子目录下的相关文档, 以详细了解日志格式及流量统计办法

(13)其它未提及事宜请参见源码及注释

